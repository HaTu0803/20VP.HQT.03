
--20 LỖI
DROP PROC IF EXISTS EX_20_READ_MONAN_DEADLOCK
go

CREATE PROC EX_20_READ_MONAN_DEADLOCK
AS
BEGIN

    BEGIN TRAN 
        BEGIN TRY 
                SELECT * FROM  MONAN 

                WAITFOR DELAY '00:00:13'

                SELECT * FROM  MONAN 
        END TRY 

        BEGIN CATCH 
            ROLLBACK TRAN
            RETURN 0
        END CATCH
    COMMIT TRAN
    RETURN 1
END 

GO
DROP PROC IF EXISTS EX_20_UPDATE_TDB_DEADLOCK 
GO
CREATE PROC EX_20_UPDATE_TDB_DEADLOCK 
    @MATD_DA_1    char(6),
    @MAMA_1       char(6),
    @GIA_1         FLOAT ,
    @MATD_DA_2    char(6),
    @MAMA_2        char(6),
    @GIA_2       FLOAT 
AS
BEGIN
SET TRANSACTION ISOLATION LEVEL  READ UNCOMMITTED
    BEGIN TRAN
    BEGIN TRY

        IF NOT EXISTS (SELECT * FROM MONAN WHERE MATD_DA = @MATD_DA_1 AND MAMA = @MAMA_1 )
        BEGIN
            ROLLBACK TRAN
            RETURN 1
        END

        IF NOT EXISTS (SELECT * FROM MONAN WHERE MATD_DA = @MATD_DA_2 AND MAMA = @MAMA_2 )
        BEGIN
            ROLLBACK TRAN
            RETURN 1
        END

        SELECT * FROM MONAN  
        UPDATE MONAN SET GIA = @GIA_1 WHERE MATD_DA = @MATD_DA_1 AND MAMA = @MAMA_1
        WAITFOR DELAY '00:00:05'
        UPDATE MONAN SET GIA = @GIA_2 WHERE MATD_DA = @MATD_DA_2 AND MAMA = @MAMA_2
        SELECT * FROM MONAN  
    END TRY

    BEGIN CATCH
        ROLLBACK TRAN 
        RETURN 0
    END CATCH

    COMMIT TRAN
    RETURN 1
END